# Интеграционные тесты воспроизводимости

Этот модуль содержит комплексные интеграционные тесты для проверки воспроизводимости RL экспериментов (User Story 4).

## Обзор

Система воспроизводимости включает несколько ключевых компонентов:

1. **Управление конфигурацией** (`src.utils.config`) - консистентность сидов
2. **Трекер зависимостей** (`src.utils.dependency_tracker`) - снимки среды
3. **Проверщик воспроизводимости** (`src.utils.reproducibility_checker`) - валидация
4. **Экспортер результатов** (`src.experiments.result_exporter`) - архивирование

## Файлы тестов

### `test_reproducibility.py`
Полные интеграционные тесты, покрывающие весь workflow воспроизводимости:

- **`test_full_reproducibility_workflow`** - Основной тест полного пайплайна:
  1. Создание конфигурации с фиксированными сидами
  2. Запуск первого эксперимента
  3. Создание снимка зависимостей
  4. Запуск второго идентичного эксперимента
  5. Сравнение результатов на воспроизводимость
  6. Экспорт результатов с метаданными
  7. Валидация полной воспроизводимости

- **`test_reproducibility_with_different_strictness_levels`** - Тестирование различных уровней строгости проверки

- **`test_reproducibility_failure_detection`** - Детектирование нарушений воспроизводимости

- **`test_determinism_validation`** - Валидация детерминизма функций

- **`test_reproducibility_with_performance_measurement`** - Измерение производительности

- **`test_edge_cases_and_error_handling`** - Граничные случаи и обработка ошибок

- **`test_comprehensive_reproducibility_report_generation`** - Генерация комплексных отчетов

### `test_reproducibility_simple.py`
Упрощенные тесты для быстрой проверки основной функциональности:

- Базовая консистентность сидов
- Детерминированность функций
- Основной workflow проверщика воспроизводимости
- Детектирование различий
- Валидация детерминизма
- Генерация отчетов
- Сравнение снимков
- Экспорт с зависимостями

## Мок-классы

### `MockReproducibleAgent`
Детерминированный агент для тестирования:
- Фиксированные сиды для воспроизводимости
- Детерминированное обучение и оценка
- Сохранение/загрузка состояния

### `MockReproducibleEnvironment`
Детерминированная среда для тестирования:
- Фиксированные сиды
- Предсказуемая динамика
- Консистентные награды

## Запуск тестов

### Все интеграционные тесты воспроизводимости
```bash
pytest tests/integration/test_reproducibility.py -v
```

### Упрощенные тесты
```bash
pytest tests/integration/test_reproducibility_simple.py -v
```

### Конкретный тест
```bash
pytest tests/integration/test_reproducibility.py::TestReproducibilityIntegration::test_full_reproducibility_workflow -v
```

### С подробным выводом
```bash
pytest tests/integration/test_reproducibility.py -v -s
```

## Проверяемые компоненты

### 1. Консистентность сидов (config.py)
- Автоматическая синхронизация сидов между компонентами
- Валидация настроек воспроизводимости
- Генерация отчетов о воспроизводимости
- Принудительная синхронизация сидов

### 2. Снимки зависимостей (dependency_tracker.py)
- Создание снимков системы и зависимостей
- Сравнение снимков для детектирования изменений
- Валидация среды для воспроизведения экспериментов
- Детектирование конфликтов зависимостей

### 3. Проверка воспроизводимости (reproducibility_checker.py)
- Регистрация запусков экспериментов
- Сравнение результатов с различными уровнями строгости
- Статистический анализ различий
- Валидация детерминизма функций
- Диагностика проблем воспроизводимости
- Генерация руководств по воспроизводимости

### 4. Экспорт результатов (result_exporter.py)
- Экспорт в различные форматы (JSON, CSV, HDF5, Excel)
- Включение снимков зависимостей
- Валидация целостности экспортированных данных
- Архивирование и сжатие

## Уровни строгости проверки

### MINIMAL
- Только базовые проверки
- Точное совпадение результатов
- Минимальные требования к производительности

### STANDARD (по умолчанию)
- Стандартные проверки + статистический анализ
- Проверка трендов обучения
- Анализ среды выполнения

### STRICT
- Строгие проверки + детальная диагностика
- Повышенная точность сравнений
- Расширенный статистический анализ

### PARANOID
- Максимально строгие проверки
- Максимальная точность
- Полная диагностика системы

## Метрики производительности

Тесты измеряют время выполнения ключевых операций:

- **Создание снимка зависимостей**: < 10 секунд
- **Выполнение эксперимента**: < 5 секунд
- **Регистрация запуска**: < 2 секунд
- **Проверка воспроизводимости**: < 5 секунд

## Обработка ошибок

Тесты проверяют корректную обработку:

- Недостаточного количества запусков для сравнения
- Ошибок в процессе обучения
- Поврежденных файлов и данных
- Проблем с созданием снимков зависимостей
- Конфликтов зависимостей

## Валидация

Система валидации проверяет:

- Целостность экспортированных данных
- Корректность JSON/CSV файлов
- Наличие всех необходимых метаданных
- Контрольные суммы файлов
- Структуру экспортированных данных

## Рекомендации по использованию

1. **Запускайте полные тесты** перед важными изменениями в системе воспроизводимости
2. **Используйте упрощенные тесты** для быстрой проверки во время разработки
3. **Проверяйте различные уровни строгости** для критически важных экспериментов
4. **Мониторьте производительность** при добавлении новых проверок
5. **Тестируйте граничные случаи** при изменении логики обработки ошибок

## Интеграция с CI/CD

Тесты можно интегрировать в пайплайн CI/CD:

```yaml
# .github/workflows/reproducibility-tests.yml
name: Reproducibility Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run reproducibility tests
        run: pytest tests/integration/test_reproducibility*.py -v
```

## Отладка

Для отладки проблем с воспроизводимостью:

1. Запустите тесты с флагом `-s` для вывода отладочной информации
2. Проверьте логи в `results/reproducibility/`
3. Изучите снимки зависимостей в `results/dependencies/`
4. Проанализируйте отчеты о воспроизводимости
5. Используйте `test_determinism_validation` для проверки конкретных функций

## Расширение тестов

При добавлении новых компонентов воспроизводимости:

1. Создайте соответствующие мок-классы
2. Добавьте тесты для новой функциональности
3. Обновите полный workflow тест
4. Проверьте интеграцию с существующими компонентами
5. Добавьте тесты производительности и обработки ошибок