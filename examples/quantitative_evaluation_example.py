#!/usr/bin/env python3
"""
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ RL –∞–≥–µ–Ω—Ç–æ–≤.

–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∞–≥–µ–Ω—Ç–∞
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–µ–π
- –ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤
- –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
"""

import tempfile
from pathlib import Path

import gymnasium as gym
import numpy as np



class DummyAgent:
    """–ü—Ä–æ—Å—Ç–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏."""

    def __init__(self, mean_reward: float = 100.0, std_reward: float = 10.0):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞.

        Args:
            mean_reward: –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞ –∞–≥–µ–Ω—Ç–∞
            std_reward: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
        """
        self.mean_reward = mean_reward
        self.std_reward = std_reward
        self.is_trained = True

    def predict(self, observation, deterministic=True):
        """–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—Å–ª—É—á–∞–π–Ω–æ–µ)."""
        return np.array([0]), None


def create_mock_env():
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π —Å—Ä–µ–¥—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏."""
    env = gym.make("CartPole-v1")
    return env


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏."""
    print("üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ RL –∞–≥–µ–Ω—Ç–æ–≤")
    print("=" * 60)

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ä–µ–¥—ã
    env = create_mock_env()
    print(f"üìä –°—Ä–µ–¥–∞: {getattr(env.spec, 'id', 'CartPole-v1')}")

    # –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    agents = {
        "–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç": DummyAgent(mean_reward=150.0, std_reward=5.0),
        "–°—Ä–µ–¥–Ω–∏–π –∞–≥–µ–Ω—Ç": DummyAgent(mean_reward=100.0, std_reward=15.0),
        "–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç": DummyAgent(mean_reward=120.0, std_reward=30.0),
    }

    print(f"ü§ñ –°–æ–∑–¥–∞–Ω–æ {len(agents)} –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏")

    # 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    print("\n1Ô∏è‚É£ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞")
    print("-" * 40)

    # agent = agents["–°—Ä–µ–¥–Ω–∏–π –∞–≥–µ–Ω—Ç"]
    
    # –ú–æ–∫–∞–µ–º –æ—Ü–µ–Ω–∫—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    print("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ü–µ–Ω–∫–∞ –∞–≥–µ–Ω—Ç–∞ –Ω–∞ 20 —ç–ø–∏–∑–æ–¥–∞—Ö...")
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:
    # metrics = evaluate_agent_standard(
    #     agent=agent,
    #     env=env,
    #     num_episodes=20,
    #     agent_name="–°—Ä–µ–¥–Ω–∏–π –∞–≥–µ–Ω—Ç"
    # )
    # print(f"‚úÖ –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞: {metrics.base_metrics.mean_reward:.2f}")
    # print(f"üìà –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: {metrics.reward_stability_score:.3f}")
    # print(f"üéØ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {metrics.base_metrics.success_rate:.1%}")

    print("‚úÖ –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞: 98.50")
    print("üìà –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: 0.850")
    print("üéØ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: 75.0%")

    # 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–µ–π
    print("\n2Ô∏è‚É£ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–µ–π")
    print("-" * 40)

    # evaluator = QuantitativeEvaluator(
    #     env=env,
    #     baseline_threshold=80.0,
    #     success_threshold=50.0,
    #     min_effect_size=0.5
    # )

    print("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ —Å –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–µ–π...")
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:
    # baseline_comparison = evaluator.compare_with_baseline(
    #     agent=agents["–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç"],
    #     baseline_agent=agents["–°—Ä–µ–¥–Ω–∏–π –∞–≥–µ–Ω—Ç"],
    #     agent_name="–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç",
    #     baseline_name="–ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è"
    # )
    # print(f"üìä –£–ª—É—á—à–µ–Ω–∏–µ: {baseline_comparison.reward_improvement:.1f}%")
    # print(f"üî¨ –†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞: {baseline_comparison.effect_size:.3f}")
    # print(f"‚ú® –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ: {baseline_comparison.practical_significance}")

    print("üìä –£–ª—É—á—à–µ–Ω–∏–µ: +52.0%")
    print("üî¨ –†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞: 1.250")
    print("‚ú® –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ: True")

    # 3. –ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤
    print("\n3Ô∏è‚É£ –ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤")
    print("-" * 40)

    print("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞–∫–µ—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤...")
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:
    # batch_result = compare_agents_statistical(
    #     agents=agents,
    #     env=env,
    #     num_episodes=15
    # )
    # print(f"üèÜ –õ—É—á—à–∏–π –∞–≥–µ–Ω—Ç: {batch_result.best_agent}")
    # print(f"üìà –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {batch_result.ranking[0][1]:.2f}")
    # print("\nüìã –†–µ–π—Ç–∏–Ω–≥ –∞–≥–µ–Ω—Ç–æ–≤:")
    # for i, (name, score) in enumerate(batch_result.ranking, 1):
    #     print(f"  {i}. {name}: {score:.2f}")

    print("üèÜ –õ—É—á—à–∏–π –∞–≥–µ–Ω—Ç: –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç")
    print("üìà –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 148.75")
    print("\nüìã –†–µ–π—Ç–∏–Ω–≥ –∞–≥–µ–Ω—Ç–æ–≤:")
    print("  1. –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç: 148.75")
    print("  2. –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç: 118.20")
    print("  3. –°—Ä–µ–¥–Ω–∏–π –∞–≥–µ–Ω—Ç: 98.50")

    # 4. –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    print("\n4Ô∏è‚É£ –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞")
    print("-" * 40)

    print("–ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ 5 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤...")
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:
    # stability_analysis = analyze_agent_stability(
    #     agent=agents["–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç"],
    #     env=env,
    #     num_runs=5,
    #     episodes_per_run=15,
    #     agent_name="–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç"
    # )
    # stability = stability_analysis["inter_run_stability"]
    # print(f"üìä –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞: {stability['mean_reward_across_runs']:.2f}")
    # print(f"üìà –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {stability['std_reward_across_runs']:.2f}")
    # print(f"üéØ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏: {stability['cv_across_runs']:.3f}")
    # print(f"‚ú® –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏: {stability['stability_consistency']:.3f}")

    print("üìä –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä–∞–¥–∞: 118.20")
    print("üìà –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: 8.50")
    print("üéØ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏: 0.072")
    print("‚ú® –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏: 0.890")

    # 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
    print("\n5Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤")
    print("-" * 40)

    with tempfile.TemporaryDirectory() as temp_dir:
        temp_path = Path(temp_dir)
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –æ—Ç—á–µ—Ç–æ–≤
        text_report_path = temp_path / "evaluation_report.txt"
        json_report_path = temp_path / "evaluation_report.json"
        csv_report_path = temp_path / "evaluation_report.csv"
        
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç—ã:
        # evaluator.generate_comprehensive_report(
        #     metrics=batch_result,
        #     save_path=text_report_path,
        #     format_type="text"
        # )
        
        print(f"üìÑ –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç: {text_report_path.name}")
        print(f"üìä JSON –æ—Ç—á–µ—Ç: {json_report_path.name}")
        print(f"üìà CSV –æ—Ç—á–µ—Ç: {csv_report_path.name}")

    # 6. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)
    print("\n6Ô∏è‚É£ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
    print("-" * 40)

    print("üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:")
    print("  ‚Ä¢ –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥")
    print("  ‚Ä¢ Box plots –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤")
    print("  ‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –¥–∏–Ω–∞–º–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è")
    print("  ‚Ä¢ Scatter plots —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ vs –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
    print("  ‚Ä¢ –ë–∞—Ä–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π")

    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:
    # evaluator.visualize_results(
    #     metrics=batch_result.agents_metrics,
    #     save_path=temp_path / "comparison_plots.png",
    #     show_plots=False
    # )

    print("\n‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print("\nüí° –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:")
    print("   1. –ó–∞–º–µ–Ω–∏—Ç–µ DummyAgent –Ω–∞ –≤–∞—à–∏—Ö –æ–±—É—á–µ–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤")
    print("   2. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–π")
    print("   3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ü–µ–Ω–∫–∏ –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É")
    print("   4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —É–ª—É—á—à–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤")

    env.close()


if __name__ == "__main__":
    main()